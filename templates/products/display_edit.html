{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}リストの編集{% endblock %}

{% block style %}
    .move-btn, .delete-btn, .add-btn, .reorder-btn {
        padding: 5px 10px;
        margin: 0 2px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 18px;
        cursor: pointer;
    }

    .delete-btn {
        background-color: #ff5722;
    }

    .add-btn {
        background-color: #2196F3;
    }

    .reorder-btn {
        background-color: #FFC107;
    }
    .fixed-btn{
        position: fixed;
        bottom: 30px;
        right: 20px;
        z-index: 999;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        padding: 15px 28px;
        font-size: 18px;
        font-weight: bold;
        border-radius: 8px;
    }
    .fixed-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    @media (max-width: 768px) {
        .fixed-btn {
            bottom: 10px;
            right: 10px;
            padding: 12px 22px;
        }
    }

    .move-btn:disabled, .delete-btn:disabled, .add-btn:disabled {
        background-color: #ddd;
        cursor: not-allowed;
    }

    .category-section {
        margin: 20px 0;
    }

    .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }

    h3 {
        margin: 0;
        font-size: 24px;
    }

    .order-input {
        width: 60px;
        text-align: center;
    }
{% endblock %}

{% block content %}
<form method="POST" action="{% url 'products:display_edit' %}">
    {% csrf_token %}
    {% for category_key, products in categories.items %}
        <div class="category-section">
            <div class="category-header">
                <h3>
                    {{ category_choices|get_item:category_key }}
                    <button type="button" class="add-btn" data-bs-toggle="modal" data-bs-target="#addModal{{ category_key }}">+ 商品を追加</button>
                </h3>
            </div>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th style="width:5%"></th>
                        <th style="width:35%">商品名</th>
                        <th style="width:5%">並び順</th>
                        <th style="width:55%">操作</th>
                    </tr>
                </thead>
                <tbody class="sortable-list" data-category="{{ category_key }}">
                    {% for product in products %}
                        <tr class="sortable-item" data-id="{{ product.id }}" data-order="{{ product.order}}">
                            <td><span class="drag-handle">≡</span></td>
                            <td>{{ product.name }}</td>
                            <td>
                                {% comment %} {{ product.order }} {% endcomment %}
                                <input type="number" name="orders[{{ product.id }}]" value="{{ product.order }}" class="order-input" min="1" readonly>
                            </td>
                            <td>
                                <button type="submit" name="action" value="up-{{ product.id }}" class="move-btn" {% if forloop.first %}disabled{% endif %}>↑</button>
                                <button type="submit" name="action" value="down-{{ product.id }}" class="move-btn" {% if forloop.last %}disabled{% endif %}>↓</button>
                                <button type="submit" name="action" value="delete-{{ product.id }}" class="delete-btn">削除</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endfor %}
    <button type="submit" name="action" value="reorder" class="reorder-btn fixed-btn">順番を更新</button>
</form>

<!-- 商品追加モーダル -->
{% for category_key, products in categories.items %}
<div class="modal fade" id="addModal{{ category_key }}" tabindex="-1" aria-labelledby="addModalLabel{{ category_key }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addModalLabel{{ category_key }}">商品を追加</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'products:display_edit' %}">
                    {% csrf_token %}
                    <!-- カテゴリを直接埋め込む -->
                    <input type="hidden" name="category" value="{{ category_key }}">
                    <input type="hidden" name="action" value="add">
                    <div class="mb-3">
                        <label for="product_name_{{ category_key }}" class="form-label">商品名</label>
                        <input type="text" class="form-control" id="product_name_{{ category_key }}" name="product_name" placeholder="商品名" required>
                    </div>
                    <button type="submit" class="btn btn-primary">追加</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}
<!-- 削除確認モーダル（コンテンツの最後に追加） -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">商品を削除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                「<span id="deleteProductName"></span>」を削除してもよろしいですか？
            </div>
            <div class="modal-footer">
                <form method="post" action="{% url 'products:display_edit' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="product_id" id="deleteProductId">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="submit" class="btn btn-danger">削除する</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- addモーダルのJavaScript修正 -->
<script>
        // 削除ボタンのイベントリスナー修正版
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault(); // デフォルトの送信を防止
                
                // valueの取得方法を修正
                const actionValue = this.getAttribute('value'); // valueをgetAttributeで取得
                const productId = actionValue.replace('delete-', '');
                
                // デバッグ出力（問題確認用）
                console.log('削除する商品ID:', productId);
                
                const productName = this.closest('tr').querySelector('td:nth-child(2)').textContent;
                
                // モーダルの設定
                const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
                document.getElementById('deleteProductId').value = productId;
                document.getElementById('deleteProductName').textContent = productName;
                
                modal.show();
            });
        });
    
        // 入力フィールドの変更監視
        document.querySelectorAll('.order-input').forEach(input => {
            // 初期値を記憶
            input.dataset.original = input.value;
            
            input.addEventListener('change', function() {
                // 値が変わったらハイライト！
                if (this.value !== this.dataset.original) {
                    this.style.backgroundColor = '#ffe0b2';
                    this.style.fontWeight = 'bold';
                    this.style.boxShadow = '0 0 3px #ff9800';
                } else {
                    this.style.backgroundColor = '';
                    this.style.fontWeight = 'normal';
                    this.style.boxShadow = '';
                }
            });
        });
        
        // ドラッグ&ドロップの設定
        if (typeof Sortable !== 'undefined') {
            document.querySelectorAll('.sortable-list').forEach(function(el) {
                new Sortable(el, {
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    onEnd: function(evt) {
                        updateOrderAfterDrag(evt.item.parentNode);
                    }
                });
            });
            console.log('Sortable initialized successfully!');
        } else {
            console.error('Sortable is not defined! ドラッグ&ドロップが使えません');
        }


    // ドラッグ後の順番更新関数
    function updateOrderAfterDrag(tbody) {
        const items = tbody.querySelectorAll('.sortable-item');

        items.forEach((item, index) => {
            const newOrder = index + 1;
            const id = item.dataset.id;
            const input = item.querySelector('.order-input');

            if (input.value != newOrder) {
                input.value = newOrder;
                input.style.backgroundColor = '#ffe0b2';
                input.style.fontWeight = 'bold';
                input.style.boxShadow = '0 0 3px #ff9800';
            }
        });

        const btn = document.querySelector('.reorder-btn');
        if (btn) {
            btn.style.animation = 'pulse 1s infinite';
            btn.style.backgroundColor = '#ff9800';
        }
    }

    // パルスアニメーション用のCSS
    if (!document.getElementById('animation-styles')) {
        const style = document.createElement('style');
        style.id = 'animation-styles';
        style.textContent = `
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            .sortable-ghost {
                opacity: 0.5;
                background: #f8f9fa;
            }
            .sortable-chosen {
                background: #fff3cd;
            }
            .drag-handle {
                cursor: move;
                margin-left: 10px;
                font-size: 20px;
            }
        `;
        document.head.appendChild(style);
    }
</script>
{% endblock %}
